name: Deploy to Heroku

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Create source tarball
        run: tar czf /tmp/deploy.tar.gz -C . .

      - name: Deploy to Heroku
        env:
          HEROKU_API_KEY: ${{ secrets.HEROKU_API_KEY }}
        run: |
          set -e
          APP_NAME="supply-chain-risk-api"

          echo "Requesting upload URL..."
          SOURCE=$(curl -sf -X POST "https://api.heroku.com/apps/$APP_NAME/sources" \
            -H "Authorization: Bearer $HEROKU_API_KEY" \
            -H "Accept: application/vnd.heroku+json; version=3" \
            -H "Content-Type: application/json")

          PUT_URL=$(echo "$SOURCE" | jq -r '.source_blob.put_url')
          GET_URL=$(echo "$SOURCE" | jq -r '.source_blob.get_url')

          echo "Uploading source..."
          curl -sf -X PUT -H "Content-Type:" --data-binary @/tmp/deploy.tar.gz "$PUT_URL"

          echo "Triggering build..."
          BUILD=$(curl -sf -X POST "https://api.heroku.com/apps/$APP_NAME/builds" \
            -H "Authorization: Bearer $HEROKU_API_KEY" \
            -H "Accept: application/vnd.heroku+json; version=3" \
            -H "Content-Type: application/json" \
            -d "{\"source_blob\":{\"url\":\"$GET_URL\",\"version\":\"$GITHUB_SHA\"}}")

          BUILD_ID=$(echo "$BUILD" | jq -r '.id')
          echo "Build started: $BUILD_ID"

          while true; do
            sleep 10
            STATUS=$(curl -sf "https://api.heroku.com/apps/$APP_NAME/builds/$BUILD_ID" \
              -H "Authorization: Bearer $HEROKU_API_KEY" \
              -H "Accept: application/vnd.heroku+json; version=3" | jq -r '.status')
            echo "Build status: $STATUS"
            if [ "$STATUS" = "succeeded" ]; then
              echo "Deploy successful!"
              exit 0
            elif [ "$STATUS" = "failed" ]; then
              echo "Deploy failed!"
              exit 1
            fi
          done
